-- DROP TABLE IF EXISTS app_version_info CASCADE;

-- CREATE TABLE public.app_version_info (
--     archive_size bigint,
--     release_datetime timestamp with time zone,
--     version character varying
-- );


-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (584268, '2011-02-28 09:04:08+01', 'A01');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (657411, '2011-03-21 13:20:55+01', 'A02');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (696246, '2011-04-12 08:06:44+02', 'A03');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (734715, '2011-08-10 21:17:54+02', 'A04');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (739532, '2011-12-28 20:22:51+01', 'A06');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (745164, '2012-01-12 23:45:27+01', 'A07');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (762220, '2012-06-06 23:28:17+02', 'A08');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (763082, '2012-06-19 23:14:39+02', 'A09');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (936629, '2012-09-03 09:21:32+02', 'A10');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (939072, '2012-10-04 00:08:06+02', 'A11');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (941748, '2012-10-12 21:27:41+02', 'A12');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (1009352, '2013-04-05 16:57:34+02', 'A13');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (1002803, '2013-05-02 15:43:09+02', 'A14');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (1003368, '2013-05-07 22:26:39+02', 'A15');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (1003552, '2013-06-19 21:19:43+02', 'A16');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3295626, '2014-01-31 20:59:57+01', 'A17');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3296646, '2014-02-16 21:47:34+01', 'A18');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3303188, '2014-03-09 10:09:20+01', 'A19');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3176154, '2014-03-16 23:00:57+01', 'A20');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3177028, '2014-03-27 12:41:18+01', 'A21');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3175346, '2014-04-03 21:38:19+02', 'A22');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3516510, '2014-10-01 09:51:52+02', 'A24');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3598659, '2015-05-21 23:34:55+02', 'A26');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3599116, '2015-06-02 21:04:44+02', 'A27');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3597544, '2015-06-25 21:41:53+02', 'A28');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3590143, '2015-08-05 12:26:35+02', 'A29');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3593401, '2015-09-21 22:54:29+02', 'A30');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3689189, '2015-12-27 18:21:03+01', 'A31');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3691836, '2016-04-29 14:41:37+02', 'A32');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3692449, '2016-05-29 22:27:53+02', 'A33');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3692514, '2016-06-15 23:09:39+02', 'A34');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3692621, '2016-06-16 22:13:26+02', 'A35');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3701372, '2016-09-06 22:30:02+02', 'A37');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3723620, '2016-12-13 22:53:48+01', 'A38');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3723004, '2017-01-23 10:04:52+01', 'A39');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3751639, '2018-01-29 22:23:17.773484+01', 'A41');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (3751567, '2018-02-13 19:14:20+01', 'A42');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5005741, '2018-08-20 22:35:34+02', 'A44');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5016031, '2018-09-15 09:25:25+02', 'A45');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5019667, '2018-09-25 19:22:27+02', 'A46');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5037771, '2018-10-28 21:19:32.15633+01', 'A47');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5066719, '2019-03-12 23:32:34+01', 'A48');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5067199, '2019-04-10 21:58:34+02', 'A49');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5343149, '2019-09-18 19:54:51+02', 'A50');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (5340790, '2019-11-16 11:16:38+01', 'A51');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6499804, '2020-04-06 21:34:43+02', 'A52');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6522758, '2020-04-28 21:36:39+02', 'A53');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6522570, '2020-05-06 17:40:07+02', 'A54');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6520762, '2020-08-15 12:32:21+02', 'A55');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6531750, '2020-08-17 22:23:50+02', 'A56');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6537146, '2020-11-16 20:53:54+01', 'A57');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6793863, '2021-04-26 08:41:35+02', 'A58');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6774806, '2021-05-19 22:34:31+02', 'A59');
-- INSERT INTO public.app_version_info (archive_size, release_datetime, version) VALUES (6796247, '2022-01-25 14:57:44+01', 'A60');

-- ALTER TABLE DataLog
-- ADD CONSTRAINT fk_simcard FOREIGN KEY (foreign_id) REFERENCES SimCard(sim_card_id);

-- CREATE OR REPLACE VIEW DataLogView AS
-- SELECT * FROM DataLog d JOIN TIME t ON (d.foreign_id = t.time_id)
-- JOIN Status s ON (d.foreign_id = s.status_id)
-- JOIN SimCard sc ON (d.foreign_id = sc.sim_card_id)
-- JOIN Device dev ON (d.foreign_id = dev.device_id);


--CORRECT BY NOW
-- SELECT (SELECT min FROM
--     (SELECT sim_imsi, MIN(whole) min
--         FROM DataLogView
--         WHERE sim_imsi IS NOT NULL
--         AND program_ver = 'A59'
--         GROUP BY sim_imsi
--         ORDER BY min ASC
--         FETCH FIRST 10 ROWS ONLY
--     ) t2
--     ORDER BY min DESC
-- LIMIT 1 ) first_appearance,
-- (SELECT release_datetime
--     FROM app_version_info
--     WHERE version = 'A59'
-- ) release_date,

-- EXTRACT(DAYS FROM 
--     (SELECT min FROM
--         (SELECT sim_imsi, MIN(whole) min
--             FROM DataLogView
--             WHERE sim_imsi IS NOT NULL
--             AND program_ver = 'A59'
--             GROUP BY sim_imsi
--             ORDER BY min ASC
--             FETCH FIRST 10 ROWS ONLY
--         ) t1
--         ORDER BY min DESC
--     LIMIT 1 
--     ) -
--     (SELECT release_datetime
--         FROM app_version_info
--         WHERE version = 'A59'
--     )
-- ) as days;



-- SELECT * FROM(
-- --     SELECT ROW_NUMBER() OVER(ORDER BY  min58) as rownumber,
-- --     min58
-- --     FROM
--         --TABLE OF ALL SIMIMSI WITH FIRST DATE OF INSTALLATION
--         (SELECT sim_imsi, MIN(whole) as min58
--         FROM DataLogView
--         WHERE sim_imsi IS NOT NULL
--         AND program_ver = 'A58'
--         GROUP BY sim_imsi
--         ORDER BY min58 ASC) d58
--         LEFT JOIN 
--         (SELECT sim_imsi, MIN(whole) as min59
--         FROM DataLogView
--         WHERE sim_imsi IS NOT NULL
--         AND program_ver = 'A59'
--         GROUP BY sim_imsi
--         ) d59
--         on d58.sim_imsi = d59.sim_imsi
        
-- ) as t;
-- -- WHERE rownumber = 10 OR (rownumber = 100 
-- -- OR rownumber = null );



SELECT sim_imsi, MIN(whole) as min58
        FROM DataLogView
        WHERE sim_imsi IS NOT NULL
        AND program_ver = 'A58'
        GROUP BY sim_imsi
        ORDER BY min58 ASC;

SELECT sim_imsi, MIN(time_conn) as min58
        FROM pa220_data
        WHERE sim_imsi IS NOT NULL
        AND program_ver = 'A58'
        GROUP BY sim_imsi
        ORDER BY min58 ASC;
